{% extends "layout/base.html" %}

{% block title %}Ch·ªçn th·ªùi gian - Spa Beauty{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">

        {% include 'booking/components/progress_bar.html' %}

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="far fa-calendar-alt me-2"></i>Ch·ªçn th·ªùi gian
                </h4>
            </div>

            <div class="card-body">
                <form method="POST" id="step4-form">
                    {{ form.hidden_tag() }}

                    <div class="row">
                        <!-- DATE -->
                        <div class="col-md-6">
                            <h5 class="mb-3">üìÖ Ch·ªçn ng√†y</h5>

                            {{ form.appointment_date(class="form-select", required=True) }}

                            <div class="alert alert-info mt-3 d-none" id="date-info">
                                <strong>Ng√†y ƒë√£ ch·ªçn:</strong>
                                <span id="selected-date-text"></span>
                            </div>
                        </div>

                        <!-- TIME -->
                        <div class="col-md-6">
                            <h5 class="mb-3">‚è∞ Ch·ªçn gi·ªù</h5>

                            {{ form.appointment_time(class="d-none") }}

                            <div class="time-slots-grid mt-2" id="time-slots">
                                <div class="row">
                                    {% for value, label in form.appointment_time.choices %}
                                    <div class="col-4 mb-2">
                                        <div class="time-slot disabled" data-time="{{ value }}">
                                            {{ label }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="alert alert-success mt-3 d-none" id="time-info">
                                <strong>Gi·ªù ƒë√£ ch·ªçn:</strong>
                                <span id="selected-time-text"></span>
                            </div>
                        </div>
                    </div>

                    <!-- SUMMARY -->
                    <div class="summary-box mt-4">
                        <h5>üìã T√≥m t·∫Øt</h5>

                        {% for service in services %}
                        <div class="d-flex justify-content-between">
                            <span>{{ service.name }}</span>
                            <span>{{ service.price|format_currency }}ƒë</span>
                        </div>
                        {% endfor %}

                        <hr>

                        <div><strong>Th·ªùi l∆∞·ª£ng:</strong> {{ total_duration }} ph√∫t</div>
                        <div>
                            <strong>Nh√¢n vi√™n:</strong>
                            {{ employee.user.name if employee else "Spa s·∫Ω ch·ªçn" }}
                        </div>

                        <div class="fw-bold fs-5 mt-2">
                            T·ªïng: {{ total_price|format_currency }}ƒë
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('main_bp.booking_step3') }}" class="btn btn-secondary">
                            ‚Üê Quay l·∫°i
                        </a>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const dateSelect = document.querySelector("select[name='appointment_date']");
    const timeInput = document.querySelector("select[name='appointment_time']");
    const slots = document.querySelectorAll(".time-slot");
    const dateInfo = document.getElementById("date-info");
    const dateText = document.getElementById("selected-date-text");
    const timeInfo = document.getElementById("time-info");
    const timeText = document.getElementById("selected-time-text");

    // Khi ch·ªçn ng√†y ‚Üí m·ªü slot gi·ªù
    dateSelect.addEventListener("change", () => {
        dateInfo.classList.remove("d-none");
        dateText.innerText = dateSelect.options[dateSelect.selectedIndex].text;

        slots.forEach(s => {
            s.classList.remove("disabled", "active");
        });

        timeInput.value = "";
        timeInfo.classList.add("d-none");
    });

    // Ch·ªçn gi·ªù
    slots.forEach(slot => {
        slot.addEventListener("click", () => {
            if (slot.classList.contains("disabled")) return;

            slots.forEach(s => s.classList.remove("active"));
            slot.classList.add("active");

            timeInput.value = slot.dataset.time;
            timeInfo.classList.remove("d-none");
            timeText.innerText = slot.dataset.time;
        });
    });
});
</script>
{% endblock %}
